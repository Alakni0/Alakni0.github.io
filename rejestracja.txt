<?php
session_start();
require "db.php";

$bladHaslo = "";
$bladLogin = "";
$bladRejestracja = "";

if ($_SERVER["REQUEST_METHOD"] === "POST" && isset($_POST["register_btn"])) {

    $login = trim($_POST["login"]);
    $password = $_POST["password"];

    if ($login === "" || $password === "") {
        $bladRejestracja = "Uzupełnij wszystkie pola.";
    } else {

        $regex = "/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d).{8,}$/";

        if (!preg_match($regex, $password)) {
            $bladHaslo = "Hasło: min. 8 znaków, duża litera, mała litera i cyfra.";
        } else {

            $stmt = $connection->prepare("SELECT id FROM konta WHERE login = ?");
            $stmt->bind_param("s", $login);
            $stmt->execute();
            $stmt->store_result();

            if ($stmt->num_rows > 0) {
                $bladLogin = "Taki login już istnieje.";
            } else {

                $hash = password_hash($password, PASSWORD_DEFAULT);
                $stmt2 = $connection->prepare(
                        "INSERT INTO konta (login, password) VALUES (?, ?)"
                );
                $stmt2->bind_param("ss", $login, $hash);

                if ($stmt2->execute()) {
                    $_SESSION["user"] = $login;
                    header("Location: dashboard.php");
                    exit();
                } else {
                    $bladRejestracja = "Błąd podczas rejestracji.";
                }

                $stmt2->close();
            }

            $stmt->close();
        }
    }
}
?>

<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Rejestracja</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h2>Rejestracja</h2>
    <form method="POST">
        <label>Login:</label><br>
        <input type="text" name="login"><br>

        <label>Hasło:</label><br>
        <input type="password" name="password"><br>
        <small style="color:gray">Min. 8 znaków, 1 duża, 1 mała, 1 cyfra</small><br><br>

        <button type="submit" name="register_btn" class="register">Zarejestruj się</button>
    </form>

    <p class="error"><?php echo $bladRejestracja; ?></p>
    <p class="error"><?php echo $bladHaslo; ?></p>
    <p class="error"><?php echo $bladLogin; ?></p>

    <hr>
    <p>Masz już konto?</p>
    <a href="logowanie.php">Wróć do logowania</a>
</div>

</body>
</html>